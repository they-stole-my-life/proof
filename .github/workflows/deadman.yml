name: Deadman Switch

on:
  push:
    branches:
      - main
    paths:
      - "proof/date.txt"
      - "proof/index-placeholder.html"
      - "proof/templates/**"
      - "proof/.github/workflows/deadman.yml"
  schedule:
    - cron: '0 15 * * *'   # 9:00 AM CST (15:00 UTC). Will be 10 AM during CDT.
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deadman
  cancel-in-progress: false

defaults:
  run:
    working-directory: proof

jobs:
  switch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine SAFE or REVEAL
        run: |
          set -e
          DATE_STR="$(cat date.txt | tr -d ' \r\n')"

          if ! echo "$DATE_STR" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
            echo "date.txt must be YYYY-MM-DD"
            exit 1
          fi

          NOW="$(date -u +%s)"
          THEN="$(date -u -d "$DATE_STR" +%s)"
          AGE="$(( (NOW - THEN) / 86400 ))"

          echo "Days since last update: $AGE"

          if [ "$AGE" -ge 2 ]; then
            echo "MODE=REVEAL" >> "$GITHUB_ENV"
          else
            echo "MODE=SAFE" >> "$GITHUB_ENV"
          fi

      - name: Build site
        env:
          MODE: ${{ env.MODE }}
          REVEAL_IDS_1: ${{ secrets.REVEAL_IDS_1 }}
          REVEAL_IDS_2: ${{ secrets.REVEAL_IDS_2 }}
          REVEAL_IDS_3: ${{ secrets.REVEAL_IDS_3 }}
          REVEAL_IDS_4: ${{ secrets.REVEAL_IDS_4 }}
          REVEAL_IDS_5: ${{ secrets.REVEAL_IDS_5 }}
          REVEAL_IDS_6: ${{ secrets.REVEAL_IDS_6 }}
        run: |
          set -e

          if [ "$MODE" = "SAFE" ]; then
            echo "SAFE MODE"
            cp index-placeholder.html index.html
            rm -f page1.html page2.html page3.html page4.html page5.html page6.html
            exit 0
          fi

          echo "REVEAL MODE"

          make_page () {
            NUM="$1"
            IDS="$2"
            IDS_B64="$(printf "%s" "$IDS" | base64 -w 0)"
            sed "s|__IDS_B64__|$IDS_B64|g" templates/pdf-shower.template.html > "page${NUM}.html"
          }

          make_page 1 "$REVEAL_IDS_1"
          make_page 2 "$REVEAL_IDS_2"
          make_page 3 "$REVEAL_IDS_3"
          make_page 4 "$REVEAL_IDS_4"
          make_page 5 "$REVEAL_IDS_5"
          make_page 6 "$REVEAL_IDS_6"

          cp page1.html index.html

      - name: Commit if changed
        env:
          MODE: ${{ env.MODE }}
        run: |
          set -e
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "deadman-bot"
          git config user.email "deadman-bot@users.noreply.github.com"
          git add -A
          git commit -m "deadman: mode update ($MODE)"
          git push
