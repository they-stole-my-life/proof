name: Deadman Switch

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 15 * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: deadman
  cancel-in-progress: false

jobs:
  switch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Determine mode
        run: |
          DATE_STR=$(cat date.txt | tr -d ' \r\n')

          if ! echo "$DATE_STR" | grep -Eq '^[0-9]{4}-[0-9]{2}-[0-9]{2}$'; then
            echo "Invalid date format"
            exit 1
          fi

          NOW=$(date -u +%s)
          THEN=$(date -u -d "$DATE_STR" +%s)
          AGE=$(( (NOW - THEN) / 86400 ))

          if [ "$AGE" -ge 2 ]; then
            echo "MODE=REVEAL" >> $GITHUB_ENV
          else
            echo "MODE=SAFE" >> $GITHUB_ENV
          fi

      - name: Build site
        env:
          MODE: ${{ env.MODE }}
          REVEAL_IDS_1: ${{ secrets.REVEAL_IDS_1 }}
        run: |
          if [ "$MODE" = "SAFE" ]; then
            cp index_placeholder.html index.html
            rm -f page1.html
            exit 0
          fi

          B64=$(printf "%s" "$REVEAL_IDS_1" | base64 -w 0)

          python3 - <<PY
import pathlib
tpl = pathlib.Path("templates/pdf-shower.template.html").read_text()
out = tpl.replace("__IDS_B64__", "${B64}")
pathlib.Path("page1.html").write_text(out)
PY

          cp page1.html index.html

      - name: Commit if changed
        run: |
          if git diff --quiet; then
            exit 0
          fi

          git config user.name "deadman-bot"
          git config user.email "deadman-bot@users.noreply.github.com"
          git add -A
          git commit -m "deadman mode update"
          git push
